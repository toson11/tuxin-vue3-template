# 使用 Dockerfile 部署项目

##### 编写 Dockerfile

```dockerfile
# 使用Node.js 20版本镜像
FROM node:20-alpine as build-stage

# 设置工作目录为/app
WORKDIR /app
# 启用Corepack（Node.js的包管理工具，用于管理和切换不同的包管理器）
RUN corepack enable
# 准备并激活最新版本的pnpm，pnpm不会安装到全局，而是在corepack的缓存目录中
RUN corepack prepare pnpm@latest --activate

# 设置npm的镜像源为国内的npm镜像
RUN npm config set registry https://registry.npmmirror.com

# 先复制安装依赖需要的文件，这部分通常不会变化，docker可以利用缓存，而不用每次都重新安装依赖
# 复制.npmrc、package.json和pnpm-lock.yaml文件到工作目录
COPY .npmrc package.json pnpm-lock.yaml ./
# 使用pnpm安装依赖，--frozen-lockfile选项确保使用锁文件中的依赖版本
RUN pnpm install --frozen-lockfile

# 复制其余的应用文件到工作目录
COPY . .
RUN pnpm build

# 生产阶段镜像构建，使用多阶段构建，每个阶段可以基于不同的基础镜像，通过从前一个阶段复制文件来减少最终镜像的大小，避免将不必要的文件包含在最终镜像中
# 使用Nginx稳定版的Alpine镜像作为生产阶段的基础镜像
FROM nginx:stable-alpine as production-stage

# 复制构建阶段生成的dist目录到Nginx的默认静态文件目录/usr/share/nginx/html
COPY --from=build-stage /app/dist /usr/share/nginx/html
# 暴露80端口，供外部访问
EXPOSE 80

# 设置Nginx为前台运行，防止容器退出
CMD ["nginx", "-g", "daemon off;"]
```

##### 构建镜像

```shell
# 自定义镜像名称为myapp，并指定Dockerfile路径为当前目录下的Dockerfile
docker build -t myapp .
```

##### 运行容器

```shell
# 使用镜像myapp创建并启动容器，将容器的80端口映射到主机的8080端口
docker run -d -p 8080:80 myapp
```
